{% set ssl = appdata.get('ssl', {}) %}

{% if 'type' in appdata.keys() and appdata['type']=='standalone' %}
  {% set container_types = ['standalone'] %}
{% else %}
  {% set container_types = ['rails', 'assets'] %}
{% endif %}

{% for container_type in container_types %}
upstream {{app}}_{{container_type}} { server 127.0.0.1:{{ appdata['ports'][container_type]['app']['host']}}; }
{% endfor %}

server {
    listen     {{ appdata.get('nginx_port', 80) }} ;
    server_name {{ appdata.get('server_name', 'default') }}; 

    client_max_body_size {{ appdata.get('client_max_body_size', '3m') }};
    rewrite_log  on;
    {% for rewrite in appdata.get('rewrites', []) %}
    rewrite {{ rewrite.pattern }} {{ rewrite.to }} {{ rewrite.type }};
    {% endfor %}

    access_log  /var/log/nginx/{{app}}.access.json logstash_json;
    error_log   /var/log/nginx/{{app}}.error.log error;

    error_page  500 502 504       /500.html;
    error_page  503               /503.html;
    error_page  404               /404.html;

    {% for proxy in appdata.get('proxies',[]) %}
    location {{ proxy['location'] }} {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass       {{ proxy['upstream'] }};
        proxy_set_header Host {{ proxy.get('host_header', '$host') }};
        proxy_connect_timeout       600;
        proxy_send_timeout          600;
        proxy_read_timeout          600;
        send_timeout                600;
    }
    {% endfor %}

    {% if 'assets' in container_types %}
    location {{ appdata.get('urlprefix','') }}/assets {

        {% if ssl.get('redirect', False) %}
        if ($http_x_forwarded_proto != 'https') {
                rewrite ^ https://$host$request_uri? permanent;
        }
        {% endif %}

        # we are not adding any new headers here as they will be set by load balancer
        proxy_set_header Host              $host;
        proxy_pass http://{{app}}_assets/assets;
    }
    {% endif %}

    location {{ appdata.get('urlprefix','/') }} {

        {% if ssl.get('redirect', False) %}
        if ($http_x_forwarded_proto != 'https') {
                rewrite ^ https://$host$request_uri? permanent;
        }
        {% endif %}

        # we are not adding any new headers here as they will be set by load balancer
        proxy_set_header Host              $host;
        {% if 'rails' in container_types %}
        proxy_pass http://{{app}}_rails;
        {% elif 'standalone' in container_types %}
        proxy_pass http://{{app}}_standalone;
        {% endif %}
    }

    {% if 'rails' in container_types %}
    location {{ appdata.get('urlprefix','') }}/ping.json {
        # we are not adding any new headers here as they will be set by load balancer

        proxy_set_header Host              $host;
        proxy_pass http://{{ app }}_rails{{ appdata.get('urlprefix','') }}/ping.json;
    }
    {% endif %}

    {% if 'assets' in container_types %}
    location {{ appdata.get('urlprefix','') }}/assets/ping.json {
        # we are not adding any new headers here as they will be set by load balancer

        proxy_set_header Host              $host;
        proxy_pass http://{{ app }}_assets/assets/ping.json;
    }
    {% endif %}


}
